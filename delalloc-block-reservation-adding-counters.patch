ext4: delalloc -- Adding per inode counters to store reserved blocks

From: Mingming cao <cmm@us.ibm.com>

Add per-inode counters to store number of resreved data blocks
and metadata blocks, due to delayed allocation.

Signed-off-by: Mingming cao <cmm@us.ibm.com>
---
 fs/ext4/ext4_i.h |    4 ++++
 fs/ext4/super.c  |    2 ++
 2 files changed, 6 insertions(+)

Index: linux-2.6.26-rc6/fs/ext4/ext4_i.h
===================================================================
--- linux-2.6.26-rc6.orig/fs/ext4/ext4_i.h	2008-06-16 14:19:40.000000000 -0700
+++ linux-2.6.26-rc6/fs/ext4/ext4_i.h	2008-06-16 14:33:37.000000000 -0700
@@ -163,6 +163,10 @@ struct ext4_inode_info {
 	/* mballoc */
 	struct list_head i_prealloc_list;
 	spinlock_t i_prealloc_lock;
+
+	/* allocation reservation info for delalloc */
+	unsigned long i_reserved_data_blocks;
+	unsigned long i_reserved_meta_blocks;
 };
 
 #endif	/* _EXT4_I */
Index: linux-2.6.26-rc6/fs/ext4/super.c
===================================================================
--- linux-2.6.26-rc6.orig/fs/ext4/super.c	2008-06-16 14:31:54.000000000 -0700
+++ linux-2.6.26-rc6/fs/ext4/super.c	2008-06-16 14:35:00.000000000 -0700
@@ -574,6 +574,8 @@ static struct inode *ext4_alloc_inode(st
 	INIT_LIST_HEAD(&ei->i_prealloc_list);
 	spin_lock_init(&ei->i_prealloc_lock);
 	jbd2_journal_init_jbd_inode(&ei->jinode, &ei->vfs_inode);
+	ei->i_reserved_data_blocks = 0;
+	ei->i_reserved_meta_blocks = 0;
 	return &ei->vfs_inode;
 }
 
