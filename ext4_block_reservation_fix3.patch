From: Dmitry Monakhov <dmonakhov@openvz.org>

If ext4_reserve_block has failed we have to drop quota.

Signed-off-by: Dmitry Monakhov <dmonakhov@openvz.org>
Acked-by: Alex Tomas <alex@clusterfs.com>
Signed-off-by: Dave Kleikamp <shaggy@linux.vnet.ibm.com>
---
 fs/ext4/balloc.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: linux-2.6.22/fs/ext4/balloc.c
===================================================================
--- linux-2.6.22.orig/fs/ext4/balloc.c	2007-07-16 01:00:32.000000000 -0700
+++ linux-2.6.22/fs/ext4/balloc.c	2007-07-16 01:00:35.000000000 -0700
@@ -1467,7 +1467,7 @@ ext4_fsblk_t ext4_new_blocks(handle_t *h
 	if (!(EXT4_I(inode)->i_state & EXT4_STATE_BLOCKS_RESERVED)) {
 		*errp = ext4_reserve_blocks(sb, num);
 		if (*errp)
-			return 0;
+			goto out;
 		reserved = num;
 	}
 
