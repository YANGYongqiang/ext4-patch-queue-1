Support large blocksize up to PAGESIZE (max 64KB) for ext4

From: Takashi Sato <sho@tnes.nec.co.jp>

Originally from Takashi Sato, rebased to 2.6.23-rc6 and tested on 64k page ppc64 box runs fine. It allows to create >4k (8k,16k,32k,64k) block size on arch that support pagesize > 4k. 

These patches support large blocksize up to PAGESIZE (max 64KB).

Signed-off-by: Takashi Sato <sho@tnes.nec.co.jp>
Signed-off-by: Mingming Cao <cmm@us.ibm.com>

---

 fs/ext4/super.c         |    5 +++++
 include/linux/ext4_fs.h |    4 ++--
 6 files changed, 18 insertions(+), 8 deletions(-)


Index: linux-2.6.23-rc8/fs/ext4/super.c
===================================================================
--- linux-2.6.23-rc8.orig/fs/ext4/super.c	2007-09-26 11:32:40.000000000 -0700
+++ linux-2.6.23-rc8/fs/ext4/super.c	2007-09-26 11:32:43.000000000 -0700
@@ -1548,6 +1548,11 @@ static int ext4_fill_super (struct super
 		goto out_fail;
 	}
 
+	if (!sb_set_blocksize(sb, blocksize)) {
+		printk(KERN_ERR "EXT4-fs: bad blocksize %d.\n", blocksize);
+		goto out_fail;
+	}
+
 	/*
 	 * The ext4 superblock will not be buffer aligned for other than 1kB
 	 * block sizes.  We need to calculate the offset from buffer start.
Index: linux-2.6.23-rc8/include/linux/ext4_fs.h
===================================================================
--- linux-2.6.23-rc8.orig/include/linux/ext4_fs.h	2007-09-26 11:32:40.000000000 -0700
+++ linux-2.6.23-rc8/include/linux/ext4_fs.h	2007-09-26 11:32:43.000000000 -0700
@@ -77,8 +77,8 @@
  * Macro-instructions used to manage several block sizes
  */
 #define EXT4_MIN_BLOCK_SIZE		1024
-#define	EXT4_MAX_BLOCK_SIZE		4096
-#define EXT4_MIN_BLOCK_LOG_SIZE		  10
+#define	EXT4_MAX_BLOCK_SIZE		65536
+#define EXT4_MIN_BLOCK_LOG_SIZE		10
 #ifdef __KERNEL__
 # define EXT4_BLOCK_SIZE(s)		((s)->s_blocksize)
 #else
