On Tue, 2007-07-10 at 21:42 -0700, Andrew Morton wrote:

From: Mingming Cao <cmm@us.ibm.com>

On Tue, 10 Jul 2007 23:21:49 -0400 "CÃ©dric Augonnet" <cedric.augonnet@gmail.com> wrote:
>
> > 2007/7/10, Andrew Morton <akpm@linux-foundation.org>:
> >
> > Hi all,
> >
> > > > +     size = sizeof(struct transaction_stats_s);
> > > > +     s->stats = kmalloc(size, GFP_KERNEL);
> > > > +     if (s == NULL) {
> > > > +             kfree(s);
> > > > +             return -EIO;
> > >
> > > ENOMEM
> >
> > I'm sorry if i missed some point, but i just don't see the use of such
> > a kfree here, not sure Andrew meant you should only return ENOMEM
> > instead, but why issuing those kfree(NULL), instead of just a if (!s)
> > return ENOMEM ?
> >
>
> You found a bug.  It was meant to be
>
> 	if (s->stats == NULL)
>

Signed-off-by: Mingming Cao <cmm@us.ibm.com>
---

 fs/jbd2/journal.c    |    2 +-
 include/linux/jbd2.h |    3 +++
 2 files changed, 4 insertions(+), 1 deletions(-)


diff --git a/fs/jbd2/journal.c b/fs/jbd2/journal.c
index ee77d51..c3406ee 100644
--- a/fs/jbd2/journal.c
+++ b/fs/jbd2/journal.c
@@ -751,7 +751,7 @@ static int jbd2_seq_history_open(struct inode *inode, struct file *file)
 		return -EIO;
 	size = sizeof(struct transaction_stats_s) * journal->j_history_max;
 	s->stats = kmalloc(size, GFP_KERNEL);
-	if (s == NULL) {
+	if (s->stats == NULL) {
 		kfree(s);
 		return -EIO;
 	}
diff --git a/include/linux/jbd2.h b/include/linux/jbd2.h
index 22e8f4e..3ad8e59 100644
--- a/include/linux/jbd2.h
+++ b/include/linux/jbd2.h
@@ -941,6 +941,9 @@ struct journal_s
 	struct transaction_stats_s *j_history;
 	int			j_history_max;
 	int			j_history_cur;
+	/*
+	 * Protect the transactions statistics history
+	 */
 	spinlock_t		j_history_lock;
 	struct proc_dir_entry	*j_proc_entry;
 	struct transaction_stats_s j_stats;
