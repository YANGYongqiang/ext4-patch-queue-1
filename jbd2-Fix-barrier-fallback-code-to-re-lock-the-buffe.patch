jbd2: Fix barrier fallback code to re-lock the buffer head

From: Theodore Ts'o <tytso@mit.edu>

If the device doesn't support write barriers, the write is retried
without ordered mode.  But the buffer head needs to be re-locked or
submit_bh will fail with on BUG(!buffer_locked(bh)).

Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
---
 fs/jbd2/commit.c |    1 +
 1 file changed, 1 insertion(+)

Index: linux-2.6.26-rc5/fs/jbd2/commit.c
===================================================================
--- linux-2.6.26-rc5.orig/fs/jbd2/commit.c	2008-06-06 17:03:39.000000000 -0700
+++ linux-2.6.26-rc5/fs/jbd2/commit.c	2008-06-06 17:03:42.000000000 -0700
@@ -168,6 +168,7 @@ static int journal_submit_commit_record(
 		spin_unlock(&journal->j_state_lock);
 
 		/* And try again, without the barrier */
+		lock_buffer(bh);
 		set_buffer_uptodate(bh);
 		set_buffer_dirty(bh);
 		ret = submit_bh(WRITE, bh);
