jbd2: blocks reservation fix for large block support

From: Mingming Cao <cmm@us.ibm.com>

The blocks per page could be less or quals to 1 with the large
block support in VM. The patch fixed the way to calculate the
number of blocks to reserve in journal in the case blocksize > pagesize.

Signed-off-by: Mingming Cao <cmm@us.ibm.com>
---

 fs/jbd2/journal.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)


diff --git a/fs/jbd2/journal.c b/fs/jbd2/journal.c
index 956a216..1eff534 100644
--- a/fs/jbd2/journal.c
+++ b/fs/jbd2/journal.c
@@ -1945,7 +1945,12 @@ void jbd2_journal_ack_err(journal_t *journal)
 
 int jbd2_journal_blocks_per_page(struct inode *inode)
 {
-	return 1 << (PAGE_CACHE_SHIFT - inode->i_sb->s_blocksize_bits);
+	int bits = PAGE_CACHE_SHIFT - inode->i_sb->s_blocksize_bits;
+
+	if (bits > 0)
+		return 1 << bits;
+	else
+		return 1;
 }
 
 /*
